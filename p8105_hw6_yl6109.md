p8105_hw6_yl6109
================
Yurou Liu
2025-11-30

## Problem 1

``` r
# Tidying data
hc_data = read_csv("./data/homicide-data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(city_state = paste(city, state, sep = ", "))
```

    ## Rows: 52179 Columns: 12
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (9): uid, victim_last, victim_first, victim_race, victim_age, victim_sex...
    ## dbl (3): reported_date, lat, lon
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
hc_df = hc_data %>% 
  filter(!city %in% c("Dallas", "Phoenix", "Kansas City", "Tulsa")) %>% 
  filter(victim_race %in% c("White", "Black")) %>% 
  mutate(resolved = ifelse(disposition == "Closed by arrest", 1, 0)) %>% 
  mutate(victim_age = ifelse(victim_age == "Unknown", NA, victim_age), 
         victim_age = as.numeric(victim_age))

# For Baltimore MD,
btm_df = hc_df %>% 
  filter(city == "Baltimore") %>% 
  filter(!is.na(victim_age))

btm_model = glm(resolved ~ victim_age + victim_sex + victim_race, data = btm_df, family = binomial())

btm_results = btm_model %>% 
  broom::tidy(conf.int = TRUE, exponentiate = TRUE)

btm_hc_sex = btm_results %>% 
  filter(term == "victim_sexMale") %>% 
  select(estimate, conf.low, conf.high)

# For each city, 
city_data = hc_df %>% 
  filter(!is.na(victim_age)) %>% 
  group_by(city_state) %>% 
  filter(length(unique(victim_sex)) == 2, 
         length(unique(resolved)) == 2) %>%
  ungroup()

nested_city_data = city_data %>% 
  group_by(city_state) %>% 
  nest() %>% 
  ungroup() 

city_logistic = function(df) {
    model = glm(resolved ~ victim_age + victim_sex + victim_race, data = df, family = binomial())
    
    broom::tidy(model, conf.int = TRUE, exponentiate = TRUE) %>%
      filter(term == "victim_sexMale") %>%
      select(estimate, conf.low, conf.high)
}

city_results = nested_city_data %>% 
  mutate(model_output = map(data, city_logistic)) %>% 
  unnest(model_output) %>% 
  select(city_state, 
         OR = estimate, 
         OR_low = conf.low, 
         OR_high = conf.high)

# Visualization
city_results_ordered = city_results %>% 
  mutate(city_state = fct_reorder(city_state, OR))

city_results_ordered %>% 
  ggplot(aes(x = city_state, y = OR, ymin = OR_low, ymax = OR_high)) + 
  geom_point(size = 1) + 
  labs(title = "Adjusted Odds Ratios for Case Resolution: 
Male vs Female Victims Across Cities") + 
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
  geom_errorbar(width = 0.2, color = "gray50") + 
  coord_flip() + 
  theme(axis.text.y = element_text(size = 5), 
        plot.title = element_text(hjust = 0.5))
```

![](p8105_hw6_yl6109_files/figure-gfm/unnamed-chunk-1-1.png)<!-- -->
Comment: This plot shows that among 41 cities, the adjusted odds ratio
for solving homicides comparing male victims to female victims of
Richnomd VA, Nashville TN, Fresno CA and Stockton CA reached 1. The CIs
for adjusted OR of 21 cities do not include 1, indicating that there is
no statistically significant gender disparity in case resolution rates
in these cities.

## Problem 2

``` r
# Bootstraps
library(p8105.datasets)
data("weather_df")

set.seed(307)

bootstraps = tibble(strap_number = 1:5000) %>% 
  mutate(strap_sample = map(strap_number, ~ {
    sample_n(weather_df, size = nrow(weather_df), replace = TRUE)
  }), 
  model = map(strap_sample, ~ lm(tmax ~ tmin + prcp, data = .x)), 
  r_squared = map_dbl(model, ~ glance(.x)$r.squared), 
  coefs = map(model, tidy))

boot_results = bootstraps %>%
  unnest(coefs) %>% 
  select(strap_number, term, estimate, r_squared) %>% 
  pivot_wider(names_from = term, 
              values_from = estimate) %>% 
  mutate(ratio = tmin / prcp) %>% 
  rename(beta_1 = tmin,
         beta_2 = prcp) %>% 
  filter(is.finite(ratio)) %>% 
  print()
```

    ## # A tibble: 5,000 × 6
    ##    strap_number r_squared `(Intercept)` beta_1   beta_2 ratio
    ##           <int>     <dbl>         <dbl>  <dbl>    <dbl> <dbl>
    ##  1            1     0.950          7.59   1.03 -0.00651 -158.
    ##  2            2     0.948          7.47   1.03 -0.00413 -249.
    ##  3            3     0.936          7.89   1.01 -0.00596 -170.
    ##  4            4     0.942          8.05   1.00 -0.00781 -129.
    ##  5            5     0.934          7.78   1.01 -0.00463 -218.
    ##  6            6     0.935          7.88   1.01 -0.00551 -184.
    ##  7            7     0.939          7.88   1.01 -0.00632 -160.
    ##  8            8     0.937          7.80   1.02 -0.00511 -200.
    ##  9            9     0.941          7.84   1.01 -0.00604 -168.
    ## 10           10     0.941          7.84   1.01 -0.00546 -186.
    ## # ℹ 4,990 more rows

``` r
# Plot: distribution of r^2
plot_r2 = boot_results %>% 
  ggplot(aes(x = r_squared)) + 
  geom_histogram() + 
  labs(title = "Bootsrap Distribution of R^2", 
       x = expression(hat(r)^2)) + 
  theme(plot.title = element_text(hjust = 0.5))

# Plot: distribution of ratio
plot_ratio = boot_results %>% 
  ggplot(aes(x = ratio)) + 
  geom_histogram() + 
  labs(title = "Bootstrap Distribution of Beta1/Beta2 Ratio", 
       x = expression(hat(beta)[1] / hat(beta)[2])) + 
  theme(plot.title = element_text(hjust = 0.5))

print(plot_r2)
```

    ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.

![](p8105_hw6_yl6109_files/figure-gfm/unnamed-chunk-2-1.png)<!-- -->

``` r
print(plot_ratio)
```

    ## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.

![](p8105_hw6_yl6109_files/figure-gfm/unnamed-chunk-2-2.png)<!-- -->

``` r
# Confidence interval for r^2
ci_r2 = boot_results %>% 
  summarize(lower = quantile(r_squared, 0.025),
            upper = quantile(r_squared, 0.975)) %>% 
  print()
```

    ## # A tibble: 1 × 2
    ##   lower upper
    ##   <dbl> <dbl>
    ## 1 0.934 0.947

``` r
# Confidence interval for ratio
ci_ratio = boot_results %>% 
  summarize(lower = quantile(ratio, 0.025),
            upper = quantile(ratio, 0.975)) %>% 
  print()
```

    ## # A tibble: 1 × 2
    ##   lower upper
    ##   <dbl> <dbl>
    ## 1 -277. -125.

Comment: The distribution of r_squared is approximately normal
distribution, the center falls around 0.04. The distribution of the
ratio of beta1 to beta2 exhibits strong right skewness, with the
majority clustering between -150 and -50.
