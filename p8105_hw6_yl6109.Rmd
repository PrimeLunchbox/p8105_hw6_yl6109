---
title: "p8105_hw6_yl6109"
author: "Yurou Liu"
date: "2025-11-30"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(modelr)
library(broom)
library(purrr)
```


## Problem 1

```{r}
# Tidying data
hc_data = read_csv("./data/homicide-data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(city_state = paste(city, state, sep = ", "))

hc_df = hc_data %>% 
  filter(!city %in% c("Dallas", "Phoenix", "Kansas City", "Tulsa")) %>% 
  filter(victim_race %in% c("White", "Black")) %>% 
  mutate(resolved = ifelse(disposition == "Closed by arrest", 1, 0)) %>% 
  mutate(victim_age = ifelse(victim_age == "Unknown", NA, victim_age), 
         victim_age = as.numeric(victim_age))

# For Baltimore MD,
btm_df = hc_df %>% 
  filter(city == "Baltimore") %>% 
  filter(!is.na(victim_age))

btm_model = glm(resolved ~ victim_age + victim_sex + victim_race, data = btm_df, family = binomial())

btm_results = btm_model %>% 
  broom::tidy(conf.int = TRUE, exponentiate = TRUE)

btm_hc_sex = btm_results %>% 
  filter(term == "victim_sexMale") %>% 
  select(estimate, conf.low, conf.high)

# For each city, 
city_data = hc_df %>% 
  filter(!is.na(victim_age)) %>% 
  group_by(city_state) %>% 
  filter(length(unique(victim_sex)) == 2, 
         length(unique(resolved)) == 2) %>%
  ungroup()

nested_city_data = city_data %>% 
  group_by(city_state) %>% 
  nest() %>% 
  ungroup() 

city_logistic = function(df) {
    model = glm(resolved ~ victim_age + victim_sex + victim_race, data = df, family = binomial())
    
    broom::tidy(model, conf.int = TRUE, exponentiate = TRUE) %>%
      filter(term == "victim_sexMale") %>%
      select(estimate, conf.low, conf.high)
}

city_results = nested_city_data %>% 
  mutate(model_output = map(data, city_logistic)) %>% 
  unnest(model_output) %>% 
  select(city_state, 
         OR = estimate, 
         OR_low = conf.low, 
         OR_high = conf.high)

# Visualization
city_results_ordered = city_results %>% 
  mutate(city_state = fct_reorder(city_state, OR))

city_results_ordered %>% 
  ggplot(aes(x = city_state, y = OR, ymin = OR_low, ymax = OR_high)) + 
  geom_point(size = 1) + 
  labs(title = "Adjusted Odds Ratios for Case Resolution: 
Male vs Female Victims Across Cities") + 
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
  geom_errorbar(width = 0.2, color = "gray50") + 
  coord_flip() + 
  theme(axis.text.y = element_text(size = 5), 
        plot.title = element_text(hjust = 0.5))
```
Comment: This plot shows that among 41 cities, the adjusted odds ratio for solving homicides comparing male victims to female victims of Richnomd VA, Nashville TN, Fresno CA and Stockton CA reached 1. The CIs for adjusted OR of 21 cities do not include 1, indicating that there is no statistically significant gender disparity in case resolution rates in these cities.

## Problem 2

```{r}
# Bootstraps
library(p8105.datasets)
data("weather_df")

set.seed(307)

bootstraps = tibble(strap_number = 1:5000) %>% 
  mutate(strap_sample = map(strap_number, ~ {
    sample_n(weather_df, size = nrow(weather_df), replace = TRUE)
  }), 
  model = map(strap_sample, ~ lm(tmax ~ tmin + prcp, data = .x)), 
  r_squared = map_dbl(model, ~ glance(.x)$r.squared), 
  coefs = map(model, tidy))

boot_results = bootstraps %>%
  unnest(coefs) %>% 
  select(strap_number, term, estimate, r_squared) %>% 
  pivot_wider(names_from = term, 
              values_from = estimate) %>% 
  mutate(ratio = tmin / prcp) %>% 
  rename(beta_1 = tmin,
         beta_2 = prcp) %>% 
  filter(is.finite(ratio)) %>% 
  print()

# Plot: distribution of r^2
plot_r2 = boot_results %>% 
  ggplot(aes(x = r_squared)) + 
  geom_histogram() + 
  labs(title = "Bootsrap Distribution of R^2", 
       x = expression(hat(r)^2)) + 
  theme(plot.title = element_text(hjust = 0.5))

# Plot: distribution of ratio
plot_ratio = boot_results %>% 
  ggplot(aes(x = ratio)) + 
  geom_histogram() + 
  labs(title = "Bootstrap Distribution of Beta1/Beta2 Ratio", 
       x = expression(hat(beta)[1] / hat(beta)[2])) + 
  theme(plot.title = element_text(hjust = 0.5))

print(plot_r2)
print(plot_ratio)

# Confidence interval for r^2
ci_r2 = boot_results %>% 
  summarize(lower = quantile(r_squared, 0.025),
            upper = quantile(r_squared, 0.975)) %>% 
  print()

# Confidence interval for ratio
ci_ratio = boot_results %>% 
  summarize(lower = quantile(ratio, 0.025),
            upper = quantile(ratio, 0.975)) %>% 
  print()
```

Comment: The distribution of r_squared is approximately normal distribution, the center falls around 0.04. The distribution of the ratio of beta1 to beta2 exhibits strong right skewness, with the majority clustering between -150 and -50.

## Problem 3

```{r}
# Data tidying
bw_data = read_csv("./data/birthweight.csv") %>% 
  janitor::clean_names()

clean_data = bw_data %>% 
  rename(
    baby_sex = babysex,
    head_circumference = bhead,
    birth_length = blength,
    birth_weight = bwt,
    delivery_weight = delwt,
    family_income = fincome,
    father_race = frace,
    gestational_age = gaweeks,
    malformations = malform,
    menarche_age = menarche,
    mother_height = mheight,
    mother_age = momage,
    mother_race = mrace,
    parity = parity,
    prior_low_birth_weight = pnumlbw,
    prior_small_gestational_age = pnumsga,
    pre_pregnancy_bmi = ppbmi,
    pre_pregnancy_weight = ppwt,
    cigarettes_per_day = smoken,
    weight_gain = wtgain
  ) %>% 
  mutate(
    baby_sex = factor(baby_sex, levels = c(1, 2)), 
    father_race = factor(father_race, levels = c(1, 2, 3, 4, 8, 9)), 
    malformations = factor(malformations, levels = c(0, 1)), 
    mother_race = factor(mother_race, levels = c(1, 2, 3, 4, 8))
  ) %>% 
  drop_na()

# Propose regression model
model_bw = lm(birth_weight ~ 
                head_circumference + 
                birth_length + 
                baby_sex + 
                malformations + 
                mother_height + 
                mother_age + 
                pre_pregnancy_bmi + 
                gestational_age + 
                parity + 
                cigarettes_per_day + 
                weight_gain + 
                family_income + 
                mother_race, 
              data = clean_data)
summary(model_bw)

model_step = step(model_bw, direction = "both") 
summary(model_step)

AIC_full = AIC(model_bw)
AIC_step = AIC(model_step)
difference = AIC_full - AIC_step

# AIC of model_step is 3.8 lower than model_bw. Thus model birth_weight ~ head_circumference + birth_length + baby_sex + mother_height + pre_pregnancy_bmi + gestational_age + parity + cigarettes_per_day + weight_gain + family_income + mother_race is better.

# Plot: residuals vs fitted values
model_final = model_step

data_with_residual = clean_data %>% 
  add_predictions(model = model_final) %>% 
  add_residuals(model = model_final)

data_with_residual %>% 
  ggplot(aes(x = pred, y = resid)) + 
  geom_point(alpha = 0.3, color = "gray20") + 
  labs(title = "Residuals vs Fitted Values", 
       x = "Fitted Values (g)", 
       y = "Residuals (g)") + 
  theme(plot.title = element_text(hjust = 0.5))

# Compare model_final with the other two models
set.seed(307)

cv_df = crossv_mc(clean_data, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  ) %>% 
  mutate(
    model_simple = map(train, ~lm(birth_weight ~ birth_length + gestational_age, data = .x)), 
    model_interaction = map(train, ~lm(birth_weight ~ head_circumference * birth_length * baby_sex, data = .x)), 
    model_final = map(train, ~lm(formula(model_final), data = .x))
  ) %>% 
  mutate(
    rmse_simple = map2_dbl(model_simple, test, ~rmse(model = .x, data = .y)),
    rmse_interaction = map2_dbl(model_interaction, test, ~rmse(model = .x, data = .y)),
    rmse_final = map2_dbl(model_final, test, ~rmse(model = .x, data = .y))
  )

cv_result = cv_df %>% 
  select(starts_with("rmse")) %>% 
  summarize(
    avg_rmse_simple = mean(rmse_simple),
    avg_rmse_interaction = mean(rmse_interaction),
    avg_rmse_final = mean(rmse_final),
    sd_rmse_simple = sd(rmse_simple),
    sd_rmse_interaction = sd(rmse_interaction),
    sd_rmse_final = sd(rmse_final)
  )
```

Comment: based on cross-validation results, the final model achieves lower prediction error (RMSE = 289.2g) compared to the simple model (332.4g) and demonstrates greater stability than the interaction model with smaller standard deviation, indicating that incorporating multiple relevant factors provides more accurate predictions of infant birth weight.